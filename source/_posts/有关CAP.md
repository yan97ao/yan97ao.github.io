---
title: 有关CAP
date: 2016-06-04 21:29:25
tags: 
	- CAP
	- 分布式
categories: tech
---
读到了三篇非常不错的文章：
[1] https://zhuanlan.zhihu.com/p/20399316
[2] https://codahale.com/you-cant-sacrifice-partition-tolerance/
[3] http://www.infoq.com/cn/articles/cap-twelve-years-later-how-the-rules-have-changed/

CAP原则又称CAP定理，指的是在一个分布式系统中， Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼得。
* 一致性（**C**onsistency）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）
* 可用性（**A**vailability）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据更新具备高可用性）
* 分区容错性（**P**artition tolerance）：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择。

<!-- more -->
关于CAP理论的介绍，文章1写的非常聪明，比较了多种典型设计方案下的CAP折衷

CAP是一种分布式系统设计时的trade off，也就是说在一些场景下，上述要求只能同时满足2个，而无论如何做不到同时满足CAP。

而实际上，抛开P而只谈AC是没有意义的，我们关注更多的，都是发生了P的场景下，该保证A还是C的问题（文章2）。在现实世界中，因为存在网络延时等原因，时时刻刻都有P情况的发生，而随后由于消息到达而得到修正。如果网络情况严重恶化造成丢包甚至网络不可达（也就是延迟无限大），就造成了广义上的P发生。在分布式设计中采用的二阶段提交协议和paxos等，都是在一定程度上避免/推迟进入A还是C的抉择

如果在P发生时选择C，那么我们就必须限制可能造成不一致的所有操作，降低系统的可用性。这样的好处是当系统从P状态恢复时，我们可以直接恢复到之前的工作状态。
如果在P发生时选择A，我们依旧可以向用户提供完整服务（可用性），但是这将不可避免的带来脑裂问题。而当系统从P状态恢复时，就不得不面临数据合并的问题。在数据合并时，通常采用的方式是先回到分区钱的状态，再把所有分区的操作按照时间顺序回放。但是在很多场景下依旧会有不能合并的情况出现，这就需要人工介入进行处理了（如git不能自动merge的场景）

